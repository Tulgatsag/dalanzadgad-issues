<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞–ª–∞–Ω–∑–∞–¥–≥–∞–¥ –•–æ—Ç—ã–Ω –ê—Å—É—É–¥–∞–ª –ë“Ø—Ä—Ç–≥—ç—Ö</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 400px; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <div class="p-4 bg-gray-800 text-white">
                <h1 class="text-2xl font-bold">–î–∞–ª–∞–Ω–∑–∞–¥–≥–∞–¥ –•–æ—Ç—ã–Ω –ê—Å—É—É–¥–∞–ª –ë“Ø—Ä—Ç–≥—ç—Ö</h1>
            </div>
            
            <div class="flex flex-col md:flex-row">
                <div class="w-full md:w-2/3 p-4">
                    <div id="map" class="border rounded-lg"></div>
                </div>
                
                <div class="w-full md:w-1/3 p-4 space-y-4">
                    <div>
                        <label class="block mb-2 font-semibold">–ë–∞–π—Ä—à–∏–ª:</label>
                        <div id="locationInfo" class="text-gray-600">
                            <p id="manualLocationText">–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –¥—ç—ç—Ä –±–∞–π—Ä—à–ª–∞–∞ —Å–æ–Ω–≥–æ–Ω–æ —É—É</p>
                            <button id="getCurrentLocationBtn" class="mt-2 bg-green-500 text-white px-3 py-1 rounded">
                                –ú–∏–Ω–∏–π –±–∞–π—Ä—à–∏–ª
                            </button>
                        </div>
                    </div>
                    
                    <select 
                        id="issueCategory" 
                        class="w-full p-2 border rounded"
                    >
                        <option value="">–ê—Å—É—É–¥–ª—ã–Ω –∞–Ω–≥–∏–ª–∞–ª —Å–æ–Ω–≥–æ—Ö</option>
                        <option value="road">–ó–∞–º, —Ç—ç—ç–≤—Ä–∏–π–Ω –∞—Å—É—É–¥–∞–ª</option>
                        <option value="communal">–•–æ—Ç —Ç–æ—Ö–∏–∂–∏–ª—Ç</option>
                        <option value="utilities">–ò–Ω–∂–µ–Ω–µ—Ä–∏–π–Ω —à—É–≥–∞–º —Å“Ø–ª–∂—ç—ç</option>
                        <option value="social">–ù–∏–π–≥–º–∏–π–Ω “Ø–π–ª—á–∏–ª–≥—ç—ç</option>
                        <option value="environment">–ë–∞–π–≥–∞–ª—å –æ—Ä—á–∏–Ω</option>
                        <option value="other">–ë—É—Å–∞–¥</option>
                    </select>
                    
                    <textarea 
                        id="issueDescription" 
                        placeholder="–ê—Å—É—É–¥–ª—ã–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π —Ç–∞–π–ª–±–∞—Ä..." 
                        class="w-full p-2 border rounded"
                        rows="4"
                    ></textarea>
                    
                    <div>
                        <input 
                            type="file" 
                            id="imageUpload" 
                            accept="image/*" 
                            class="hidden"
                        />
                        <label 
                            for="imageUpload" 
                            class="w-full block text-center cursor-pointer bg-gray-200 hover:bg-gray-300 p-2 rounded"
                        >
                            üñºÔ∏è –ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö
                        </label>
                        <img 
                            id="selectedImage" 
                            class="max-w-48 max-h-48 mt-2 hidden" 
                            alt="–°–æ–Ω–≥–æ—Å–æ–Ω –∑—É—Ä–∞–≥"
                        />
                    </div>
                    
                    <button 
                        id="addIssueBtn" 
                        class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 disabled:bg-gray-400"
                        disabled
                    >
                        –ê—Å—É—É–¥–∞–ª –±“Ø—Ä—Ç–≥—ç—Ö
                    </button>
                </div>
            </div>
            
            <div id="issuesList" class="p-4 bg-gray-50">
                <h2 class="text-xl font-semibold mb-4">–ë“Ø—Ä—Ç–≥—ç—Å—ç–Ω –ê—Å—É—É–¥–ª—É—É–¥</h2>
                <div id="issuesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        // –î–∞–ª–∞–Ω–∑–∞–¥–≥–∞–¥ —Ö–æ—Ç—ã–Ω —ç—Ö–ª—ç—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        const DALANZADGAD_LAT = 43.5725;
        const DALANZADGAD_LNG = 104.4372;

        // –ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ “Ø“Ø—Å–≥—ç—Ö
        const map = L.map('map').setView([DALANZADGAD_LAT, DALANZADGAD_LNG], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
        const locationInfo = document.getElementById('locationInfo');
        const manualLocationText = document.getElementById('manualLocationText');
        const getCurrentLocationBtn = document.getElementById('getCurrentLocationBtn');
        const issueCategory = document.getElementById('issueCategory');
        const issueDescription = document.getElementById('issueDescription');
        const imageUpload = document.getElementById('imageUpload');
        const selectedImage = document.getElementById('selectedImage');
        const addIssueBtn = document.getElementById('addIssueBtn');
        const issuesContainer = document.getElementById('issuesContainer');

        // –•—É–≤—å—Å–∞–≥—á–∏–¥
        let currentLocation = null;
        let issues = [];
        let currentMarker = null;

        // –ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –¥—ç—ç—Ä —Ç–æ–≤—à–∏—Ö “Ø–µ–∏–π–Ω “Ø–π–ª —è–≤—Ü
        map.on('click', (e) => {
            // ”®–º–Ω”©—Ö –º–∞—Ä–∫–µ—Ä—ã–≥ —É—Å—Ç–≥–∞—Ö
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // –®–∏–Ω—ç –º–∞—Ä–∫–µ—Ä “Ø“Ø—Å–≥—ç—Ö
            currentLocation = e.latlng;
            currentMarker = L.marker([currentLocation.lat, currentLocation.lng]).addTo(map);
            
            manualLocationText.textContent = `”®—Ä–≥”©—Ä”©–≥: ${currentLocation.lat.toFixed(4)}, –£—Ä—Ç—Ä–∞–≥: ${currentLocation.lng.toFixed(4)}`;
            validateForm();
        });

        // –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –±–∞–π—Ä—à–ª—ã–≥ –∞–≤–∞—Ö
        getCurrentLocationBtn.addEventListener('click', () => {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition((position) => {
                    // ”®–º–Ω”©—Ö –º–∞—Ä–∫–µ—Ä—ã–≥ —É—Å—Ç–≥–∞—Ö
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }

                    // –®–∏–Ω—ç –±–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö
                    currentLocation = {
                        lat: position.coords.latitude, 
                        lng: position.coords.longitude
                    };

                    // –®–∏–Ω—ç –º–∞—Ä–∫–µ—Ä “Ø“Ø—Å–≥—ç—Ö
                    currentMarker = L.marker([currentLocation.lat, currentLocation.lng]).addTo(map);
                    
                    // –ì–∞–∑—Ä—ã–Ω –∑—É—Ä–≥–∏–π–≥ —à–∏–Ω—ç –±–∞–π—Ä—à–∏–ª —Ä—É—É —à–∏–ª–∂“Ø“Ø–ª—ç—Ö
                    map.setView([currentLocation.lat, currentLocation.lng], 15);
                    
                    manualLocationText.textContent = `”®—Ä–≥”©—Ä”©–≥: ${currentLocation.lat.toFixed(4)}, –£—Ä—Ç—Ä–∞–≥: ${currentLocation.lng.toFixed(4)}`;
                    validateForm();
                }, (error) => {
                    alert('–ë–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ' + error.message);
                });
            } else {
                alert('–¢–∞–Ω—ã —Ç”©—Ö”©”©—Ä”©–º–∂ –±–∞–π—Ä—à–∏–ª —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ—Ö –±–æ–ª–æ–º–∂–≥“Ø–π –±–∞–π–Ω–∞.');
            }
        });

        // –ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ—Ö “Ø–π–ª —è–≤—Ü
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    selectedImage.src = event.target.result;
                    selectedImage.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // –§–æ—Ä–º—ã–Ω “Ø–π–ª —è–≤—Ü—ã–≥ —à–∞–ª–≥–∞—Ö
        function validateForm() {
            const hasLocation = !!currentLocation;
            const hasDescription = issueDescription.value.trim() !== '';
            const hasCategory = issueCategory.value !== '';
            addIssueBtn.disabled = !(hasLocation && hasDescription && hasCategory);
        }

        // –ê—Å—É—É–¥–∞–ª –Ω—ç–º—ç—Ö “Ø–π–ª —è–≤—Ü
        addIssueBtn.addEventListener('click', () => {
            if (!currentLocation || !issueDescription.value.trim() || !issueCategory.value) return;

            // –®–∏–Ω—ç –∞—Å—É—É–¥–∞–ª “Ø“Ø—Å–≥—ç—Ö
            const newIssue = {
                id: Date.now(),
                location: currentLocation,
                description: issueDescription.value.trim(),
                category: issueCategory.value,
                image: selectedImage.src
            };

            // ”®–Ω–≥”© —Å–æ–Ω–≥–æ—Ö
            const categoryColors = {
                'road': 'red',
                'communal': 'blue',
                'utilities': 'green',
                'social': 'purple',
                'environment': 'orange',
                'other': 'gray'
            };

            // –ú–∞—Ä–∫–µ—Ä “Ø“Ø—Å–≥—ç—Ö
            const marker = L.marker(
                [newIssue.location.lat, newIssue.location.lng], 
                {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:${categoryColors[newIssue.category] || 'gray'}; 
                               width: 20px; height: 20px; border-radius: 50%;"></div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }
            )
            .addTo(map)
            .bindPopup(`
                <div>
                    <strong>–ê–Ω–≥–∏–ª–∞–ª:</strong> ${getCategortLabel(newIssue.category)}<br>
                    <p>${newIssue.description}</p>
                    ${newIssue.image ? `<img src="${newIssue.image}" alt="–ê—Å—É—É–¥–ª—ã–Ω –∑—É—Ä–∞–≥" style="max-width:200px; max-height:200px;"/>` : ''}
                </div>
            `);

            // –ê—Å—É—É–¥–ª—É—É–¥—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ –Ω—ç–º—ç—Ö
            issues.push(newIssue);
            renderIssues();

            // –§–æ—Ä–º—ã–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö
            currentLocation = null;
            manualLocationText.textContent = '–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –¥—ç—ç—Ä –±–∞–π—Ä—à–ª–∞–∞ —Å–æ–Ω–≥–æ–Ω–æ —É—É';
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            issueDescription.value = '';
            issueCategory.value = '';
            selectedImage.src = '';
            selectedImage.classList.add('hidden');
            imageUpload.value = '';
            addIssueBtn.disabled = true;
        });

        // –ê–Ω–≥–∏–ª–ª—ã–Ω —à–æ—à–≥—ã–≥ —Ö”©—Ä–≤“Ø“Ø–ª—ç—Ö
        function getCategortLabel(category) {
            const labels = {
                'road': '–ó–∞–º, —Ç—ç—ç–≤—Ä–∏–π–Ω –∞—Å—É—É–¥–∞–ª',
                'communal': '–•–æ—Ç —Ç–æ—Ö–∏–∂–∏–ª—Ç',
                'utilities': '–ò–Ω–∂–µ–Ω–µ—Ä–∏–π–Ω —à—É–≥–∞–º —Å“Ø–ª–∂—ç—ç',
                'social': '–ù–∏–π–≥–º–∏–π–Ω “Ø–π–ª—á–∏–ª–≥—ç—ç',
                'environment': '–ë–∞–π–≥–∞–ª—å –æ—Ä—á–∏–Ω',
                'other': '–ë—É—Å–∞–¥'
            };
            return labels[category] || category;
        }

        // –ê—Å—É—É–¥–ª—É—É–¥—ã–≥ –¥—ç–ª–≥—ç—Ü—ç–Ω –¥—ç—ç—Ä —Ö–∞—Ä—É—É–ª–∞—Ö
        function renderIssues() {
            issuesContainer.innerHTML = issues.map(issue => `
                <div class="bg-white shadow rounded-lg p-4">
                    <div class="flex items-center mb-2">
                        <div class="w-4 h-4 mr-2 rounded-full" style="background-color:${
                            {
                                'road': 'red',
                                'communal': 'blue',
                                'utilities': 'green',
                                'social': 'purple',
                                'environment': 'orange',
                                'other': 'gray'
                            }[issue.category] || 'gray'
                        }"></div>
                        <p class="font-semibold">${getCategortLabel(issue.category)}</p>
                    </div>
                    <p class="text-sm mb-2">${issue.description}</p>
                    <p class="text-xs text-gray-600 mb-2">
                        –ë–∞–π—Ä—à–∏–ª: ${issue.location.lat.toFixed(4)}, ${issue.location.lng.toFixed(4)}
                    </p>
                    ${issue.image ? `
                        <img 
                            src="${issue.image}" 
                            alt="–ê—Å—É—É–¥–ª—ã–Ω –∑—É—Ä–∞–≥" 
                            class="w-full h-48 object-cover rounded"
                        />
                    ` : ''}
                </div>
            `).join('');
        }

        // –§–æ—Ä–º—ã–Ω ”©”©—Ä—á–ª”©–ª—Ç–∏–π–≥ —Å–æ–Ω—Å–æ—Ö
        issueDescription.addEventListener('input', validateForm);
        issueCategory.addEventListener('change', validateForm);
    </script>
</body>
</html>